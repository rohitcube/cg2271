/*******************************
 * Simple FreeRTOS Program: Turn External RGB LED (Green + Red Channels) On/Off Based on Global Variable
 * Board: FRDM-MCXC444 (NXP MCXC444VLH MCU)
 * - External RGB LED Green Channel: PTA12 (Arduino D3 header)
 * - External RGB LED Red Channel: PTA5 (Arduino D5 header)
 *
 * Behavior:
 * - Both green and red channels are ON when g_led_state = true (1), OFF when false (0).
 * - The global variable can be changed dynamically (e.g., from another task/ISR in your full program).
 * - For testing: Set g_led_state = true in main() â€“ both stay stable ON (no blink).
 * - Add your own logic (e.g., another task) to change g_led_state during runtime.
 *******************************/

#include <stdio.h>
#include <stdbool.h>  // For bool type
#include "board.h"
#include "peripherals.h"
#include "pin_mux.h"
#include "clock_config.h"
#include "fsl_debug_console.h"
#include "FreeRTOS.h"
#include "task.h"

#define EXTERNAL_GREEN_PIN 12  // PTA12 (Arduino D3 header)
#define EXTERNAL_RED_PIN 5     // PTA5 (Arduino D5 header)

// Global variable: false (0) = off, true (1) = on
volatile bool g_led_state = false;  // Volatile for dynamic changes

void delay(uint32_t count) {
    volatile uint32_t i = 0;
    for (i = 0; i < count; ++i) {
        __asm("NOP");
    }
}

// Adapted init for external pins on Port A (both green and red)
void initLEDs() {
    SIM->SCGC5 |= SIM_SCGC5_PORTA_MASK;  // Enable clock for Port A (shared)

    // Green pin config
    PORTA->PCR[EXTERNAL_GREEN_PIN] &= ~PORT_PCR_MUX_MASK;
    PORTA->PCR[EXTERNAL_GREEN_PIN] |= PORT_PCR_MUX(1);  // GPIO mode
    GPIOA->PDDR |= (1 << EXTERNAL_GREEN_PIN);  // Set as output

    // Red pin config
    PORTA->PCR[EXTERNAL_RED_PIN] &= ~PORT_PCR_MUX_MASK;
    PORTA->PCR[EXTERNAL_RED_PIN] |= PORT_PCR_MUX(1);  // GPIO mode
    GPIOA->PDDR |= (1 << EXTERNAL_RED_PIN);  // Set as output
}

// Turn external green LED on
void ledGreenOn() {
    GPIOA->PCOR |= (1 << EXTERNAL_GREEN_PIN);  // Active-low: clear to ON (adjust if active-high)
}

// Turn external green LED off
void ledGreenOff() {
    GPIOA->PSOR |= (1 << EXTERNAL_GREEN_PIN);  // Active-low: set to OFF
}

// Turn external red LED on
void ledRedOn() {
    GPIOA->PCOR |= (1 << EXTERNAL_RED_PIN);  // Active-low: clear to ON (adjust if active-high)
}

// Turn external red LED off
void ledRedOff() {
    GPIOA->PSOR |= (1 << EXTERNAL_RED_PIN);  // Active-low: set to OFF
}

// FreeRTOS Task: Set both LEDs based on g_led_state (stable on/off, no blink)
void vLedTask(void *pvParameters) {
    for (;;) {
        if (g_led_state) {
        	ledGreenOn();
        	            delay(400000);  // ~500ms ON
        	            ledGreenOff();
        	            delay(800000);  // ~500ms OFF
        } else {
        	ledRedOn();
        	            delay(400000);  // ~500ms ON
        	            ledRedOff();
        	            delay(400000);  // ~500ms OFF
        }
        vTaskDelay(pdMS_TO_TICKS(10));  // Small delay to check for changes; optional
    }
}

int main(void) {
    /* Init board hardware from your setup code */
    BOARD_InitBootPins();
    BOARD_InitBootClocks();
    BOARD_InitBootPeripherals();
#ifndef BOARD_INIT_DEBUG_CONSOLE_PERIPHERAL
    BOARD_InitDebugConsole();
#endif

    PRINTF("External RGB LED (Green on PTA12/D3, Red on PTA5/D5) controlled by g_led_state (stable on/off)\r\n");

    // Init LEDs
    initLEDs();

    // Example for testing: Set to true (ON); in your full program, change dynamically
    g_led_state = false;

    // Create the LED task
    xTaskCreate(vLedTask, "LED", 128, NULL, 1, NULL);

    // Start FreeRTOS scheduler
    vTaskStartScheduler();

    // Should never reach here
    while (1) __asm("nop");
    return 0;
}
